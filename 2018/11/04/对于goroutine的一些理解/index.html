<html>
<head><meta name="generator" content="Hexo 3.8.0">
	
	<title>对于goroutine的一些理解</title>
	<meta name="keywords" content="刘洋,刘洋的blog">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css">
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3">
    
    

</head>

<body>


<h2 class="title">对于goroutine的一些理解</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2018年11月4日


    <a class="article-category-link" href="/categories/学习/">学习</a>



 </div>
--->


<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#goroutine的实现"><span class="toc-text">goroutine的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#goroutine-和线程的区别"><span class="toc-text">goroutine 和线程的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常见-goroutine-阻塞"><span class="toc-text">常见 goroutine 阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reference"><span class="toc-text">reference</span></a></li></ol>
<blockquote>
<p>goroutine 就是 Go语言提供的一种用户态线程，当然这种用户态线程是跑在内核级线程之上的…<br><a id="more"></a></p>
</blockquote>
<h3 id="goroutine的实现"><a href="#goroutine的实现" class="headerlink" title="goroutine的实现"></a>goroutine的实现</h3><p>goroutine 就是 Go语言提供的一种用户态线程，当然这种用户态线程是跑在内核级线程之上的。当我们创建了很多的 goroutine，并且它们都是跑在同一个内核线程之上的时候，就需要一个调度器来维护这些 goroutine，确保所有的 goroutine 都使用 cpu，并且是尽可能公平的使用 cpu 资源。<br>地鼠(gopher)用小车运着一堆待加工的砖。M 就可以看作图中的地鼠，P 就是小车，G 就是小车里装的砖。如果 G 太多了，需要创建更多个 M 去干活。没有 P，M 是不能运砖的。一个 M 坏了，runtime 将G 放到仓库中(全局队列中),再找新的 M 去运砖。  </p>
<h3 id="goroutine-和线程的区别"><a href="#goroutine-和线程的区别" class="headerlink" title="goroutine 和线程的区别"></a>goroutine 和线程的区别</h3><ol>
<li>内存占用：<br>2KB VS 1M，创建多了，栈溢出 vs OutOfMemory，为了防止栈溢出，runtime 栈分裂，创建一个原先2倍的栈空间。<br>v1.3之前分段栈：优势是可以按需增长，空间利用率比较高，但回收的时候for循环反复执行栈收缩有性能问题。<br>v1.3连续栈：空间连续，分配两倍，不会反复执行栈收缩。</li>
<li>创建和销毁的开销：<br>goroutine 有自己的 runtime 运行时处理，不需要人工处理；线程从 os 请求资源，之后再释放，即使是线程池，开销也较大。</li>
<li>切换开销：<br>goroutine 是非抢占式，协同合作，切换时只保留三个寄存器即可(<code>程序指针、栈指针、DX</code>)<br>线程调度是抢占式，切换/恢复时需要保存<code>16寄存器</code>，开销较大。  </li>
</ol>
<h3 id="常见-goroutine-阻塞"><a href="#常见-goroutine-阻塞" class="headerlink" title="常见 goroutine 阻塞"></a>常见 goroutine 阻塞</h3><p>网络 i/o、time.Sleep、channel操作、sync包一些会堵塞的操作。<br>不会造成线程堵塞，因为 runtime 将队列中 goroutine 调度到其它线程 M 去运行。  </p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><blockquote>
<p><a href="https://www.zhihu.com/question/20862617/answer/131341519" target="_blank" rel="noopener">https://www.zhihu.com/question/20862617/answer/131341519</a><br><a href="https://zhuanlan.zhihu.com/p/28381197" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/28381197</a></p>
</blockquote>


<!--<a href="http://yoursite.com/2018/11/04/对于goroutine的一些理解/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=&web_id=" language="JavaScript"></script>script>
</div>






</body>
</html>